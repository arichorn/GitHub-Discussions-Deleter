name: Delete Discussions
on:
  workflow_dispatch:

jobs:
  delete-discussions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch Discussions
        run: |
          REPO_API_URL=$(jq -r '.repository_url' $GITHUB_EVENT_PATH)
          DISCUSSIONS_API_URL="${REPO_API_URL}/discussions"
    
          curl -s -X GET -u "x-access-token:${GITHUB_TOKEN}" "${DISCUSSIONS_API_URL}" > discussions.json

      - name: Delete Discussions
        id: delete-discussions
        run: |
          TOKEN=$GITHUB_TOKEN
          DISCUSSIONS_JSON=$(cat discussions.json)
          DISCUSSION_IDS=$(echo $DISCUSSIONS_JSON | jq -r '.[] | .id')

          for DISCUSSION_ID in $DISCUSSION_IDS; do
            DISCUSSION_API_URL="${DISCUSSIONS_API_URL}/${DISCUSSION_ID}"
            curl -s -X DELETE -u "x-access-token:${TOKEN}" "${DISCUSSION_API_URL}"
          done

      - name: Delete Specific Discussion
        id: delete-specific-discussion
        run: |
          TOKEN=$GITHUB_TOKEN
          DISCUSSION_URL="https://github.com/qnblackcat/uYouPlus/discussions/269"
          DISCUSSION_ID=$(echo $DISCUSSION_URL | awk -F'/' '{print $NF}')
          DISCUSSION_API_URL="${DISCUSSIONS_API_URL}/${DISCUSSION_ID}"
          curl -s -X DELETE -u "x-access-token:${TOKEN}" "${DISCUSSION_API_URL}"
